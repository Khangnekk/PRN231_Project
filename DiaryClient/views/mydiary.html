<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Diary Entry</title>
    <link rel="stylesheet" href="../assets/css/mydiary.css">
</head>

<body>
    <div class="nav">
        <div class="logo">
            <a href="#">
                <h2>My Diary - PRN231</h2>
            </a>
        </div>
        <div class="avt-dropdown">
            <img src="https://scontent.fhph1-1.fna.fbcdn.net/v/t39.30808-1/366967596_1841531342929133_1888577435283183090_n.jpg?stp=dst-jpg_p200x200&_nc_cat=100&ccb=1-7&_nc_sid=0ecb9b&_nc_eui2=AeF-5cRgMJbCtyEHnsqopZXDPxW872EvFdg_FbzvYS8V2LM7UyGXdJ3rfcb4sbEkEsslkKBuM_62lCutR9cIctvy&_nc_ohc=J8wgos7jz_EQ7kNvgF4lbvb&_nc_ht=scontent.fhph1-1.fna&gid=ACX7ItopG4-tsAHsrl7zCv5&oh=00_AYDnW_kMYYD39cRjo71PdW5mR144YKfykpRyJNQFW8f7mg&oe=668DCE93"
                height="40" title="Nguyễn Lương Khang" id="avatar">
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="#">Profile</a>
                <a href="#">Settings</a>
                <a onclick="logout()">Logout</a>
            </div>
        </div>
    </div>
    <div class="container">
        <form id="diaryEntryForm">
            <div class="userInfo">
                <img src="https://scontent.fhph1-1.fna.fbcdn.net/v/t39.30808-1/366967596_1841531342929133_1888577435283183090_n.jpg?stp=dst-jpg_p200x200&_nc_cat=100&ccb=1-7&_nc_sid=0ecb9b&_nc_eui2=AeF-5cRgMJbCtyEHnsqopZXDPxW872EvFdg_FbzvYS8V2LM7UyGXdJ3rfcb4sbEkEsslkKBuM_62lCutR9cIctvy&_nc_ohc=J8wgos7jz_EQ7kNvgF4lbvb&_nc_ht=scontent.fhph1-1.fna&gid=ACX7ItopG4-tsAHsrl7zCv5&oh=00_AYDnW_kMYYD39cRjo71PdW5mR144YKfykpRyJNQFW8f7mg&oe=668DCE93"
                    height="50" />
                <div>
                    <h3>Nguyễn Lương Khang</h3>
                    <p>now</p>
                </div>
            </div>
            <textarea id="entryContent" placeholder="How are you today?"></textarea>
            <select id="entryPrivacy" name="Privacy">
                <option value="public">Public</option>
                <option value="private">Private</option>
            </select>
            <input type="button" class="button" value="Post" onclick="postDiaryEntry()">
        </form>

        <h2>Your Previous Entries</h2>
        <div id="diariesContainer"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            loadPreviousEntries();

            function loadPreviousEntries() {
                var token = localStorage.getItem("token");

                $.ajax({
                    url: "http://localhost:5109/api/Diary/getUserEntries",
                    type: "GET",
                    headers: { "Authorization": "Bearer " + token },
                    success: function (response) {
                        response.forEach(function (diary) {
                            var diaryHtml = `<div class="diary">
                <div class="diary-header">
                  <div class="diary-avatar">
                    <img src="data:image/png;base64,${diary.avatar}" alt="Avatar">
                  </div>
                  <div class="diary-user-info">
                    <p><strong>${diary.userName}</strong></p>
                  </div>
                </div>
                <div class="diary-content">
                  <p>${diary.content}</p>
                </div>
                <div class="diary-comments" id="comments-${diary.id}">
                  <textarea id="comment-${diary.id}" placeholder="Write a comment..."></textarea>
                  <button onclick="postComment(${diary.id})">Post Comment</button>
                </div>
              </div>`;
                            $("#diariesContainer").append(diaryHtml);
                            loadComments(diary.id);
                        });
                    },
                    error: function (xhr, status, error) {
                        alert("Failed to load diaries: " + xhr.responseText);
                    }
                });
            }

            function loadComments(diaryId) {
                var token = localStorage.getItem("token");

                $.ajax({
                    url: `http://localhost:5109/api/Diary/${diaryId}/comments`,
                    type: "GET",
                    headers: { "Authorization": "Bearer " + token },
                    success: function (response) {
                        var commentsHtml = response.map(comment => `<div class="comment">${comment}</div>`).join("");
                        $(`#comments-${diaryId}`).html(commentsHtml);
                    },
                    error: function (xhr, status, error) {
                        alert("Failed to load comments: " + xhr.responseText);
                    }
                });
            }

            // Avatar dropdown menu functionality
            const avatar = document.getElementById('avatar');
            const dropdownMenu = document.getElementById('dropdownMenu');

            avatar.addEventListener('click', () => {
                dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
            });

            window.addEventListener('click', (event) => {
                if (event.target !== avatar && !avatar.contains(event.target)) {
                    dropdownMenu.style.display = 'none';
                }
            });

            

            function postComment(diaryId) {
                var comment = $(`#comment-${diaryId}`).val();
                var token = localStorage.getItem("token");

                $.ajax({
                    url: `http://localhost:5109/api/Diary/${diaryId}/comment`,
                    type: "POST",
                    contentType: "application/json",
                    headers: { "Authorization": "Bearer " + token },
                    data: JSON.stringify({ Comment: comment }),
                    success: function (response) {
                        alert("Comment posted successfully!");
                        $(`#comment-${diaryId}`).val("");
                        loadComments(diaryId);
                    },
                    error: function (xhr, status, error) {
                        alert("Failed to post comment: " + xhr.responseText);
                    }
                });
            }

            window.postComment = postComment; // Để hàm postComment có thể được gọi từ HTML
        });

        function postDiaryEntry() {
            var content = $("#entryContent").val();
            var privacy = $("#entryPrivacy").val();
            var token = localStorage.getItem("token");

            $.ajax({
                url: "http://localhost:5109/api/Diary/post",
                type: "POST",
                contentType: "application/json",
                headers: { "Authorization": "Bearer " + token },
                data: JSON.stringify({ Content: content, Privacy: privacy }),
                success: function (response) {
                    alert("Diary entry posted successfully!");
                    window.location.href = "diary_entry.html";
                },
                error: function (xhr, status, error) {
                    alert("Failed to post diary entry: " + xhr.responseText);
                }
            });
        }

        function logout(){
                localStorage.setItem("token", null); 
                window.location.href = "../"; 
            }
    </script>
</body>

</html>